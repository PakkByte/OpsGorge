name: OpsGorge â€” Validate (Enforced)

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Perfection Loop gate (file-only)
        shell: pwsh
        run: |
          $pl = Join-Path $env:GITHUB_WORKSPACE "PL.md"
          if (-not (Test-Path $pl)) { Write-Error "PL.md missing at repo root."; exit 1 }
          $body = Get-Content $pl -Raw
          if ($body -notmatch '(?im)^\s*##\s*Perfection Loop') { Write-Error "PL.md missing '## Perfection Loop' heading."; exit 1 }
          $m = [regex]::Match($body,'(?im)PL-Score:\s*(\d+)\s*/\s*10')
          if (-not $m.Success) { Write-Error "PL.md missing 'PL-Score: n/10'."; exit 1 }
          $score = [int]$m.Groups[1].Value
          if ($score -lt 9) { Write-Error "PL-Score too low ($score/10)"; exit 1 }
          Write-Host "Perfection Loop gate OK (score: $score/10)."

      - name: Enforce Definition of Done (Strict)
        shell: pwsh
        run: |
          $script = Join-Path $env:GITHUB_WORKSPACE 'scripts\check-dod.ps1'
          if (-not (Test-Path $script)) { Write-Error "DoD script not found at $script"; exit 1 }
          pwsh -File $script -RepoRoot $env:GITHUB_WORKSPACE -Strict
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
